<!doctype html>
<html>
<head>
    <title>Actualiza servidor</title>
    <meta name="viewport" content="width=device-width">
	<meta charset='utf-8'>
    <script src='file:///android_asset/app.js'></script>
    <script src="../Misc/jquery-3.1.1.js"></script>
</head>
<script>
    $(document).ready(function() {
		var auth = app.LoadNumber( 'auth', 0 );
		if ( auth == 0 ) {
			alert('O usuário não é cadastrado');
		    window.location.href = "../saramoz.html";
		}
		var curdir = app.GetAppPath();
		var server_php = 'http://sis-ma.in/sara/php/';
		var fileTables = curdir + '/Html/tables.xml';
		var fileForm1 = curdir + '/Html/form_main.xml';
		var url1 = server_php + 'sara_tables_to_xml.php';
		var ajax1 = get_tables(url1, fileTables);
		var url2 = server_php + 'sara_from_http_to_field1.php';
		var ajax2 = send_form(url2,fileForm1);

		// https://medium.com/coding-design/writing-better-ajax-8ee4a7fb95f#.qnqc51f9x
		$.when(ajax1, ajax2).done(function() {
			$('#voltar').prop('disabled',false);
		});

//----------------------------------------------------------------------------------------------------------------------
        $('#voltar').click(function(){
            window.location.href = "../saramoz.html";
        });
//----------------------------------------------------------------------------------------------------------------------
		function get_tables(url,file) {
    		$.ajax({
				url: url,
				type: 'GET',
				dataType: 'html',
				beforeSend: function(a){  },
				success: function(a){
					app.WriteFile(file,a,"utf-8");
					$('#msg1').text('Tabelas locais actualizadas').css('color','green');
        		},
				error: function(a,b,c){ 
					$('#res').append('Houve problemas de conexão. Aabelas locais não foram actualizadas. Tente mais tarde.');
				},
				complete: function(a,b){ }
			});
		}
//----------------------------------------------------------------------------------------------------------------------
		function send_form(url,file) {
			if (! app.FileExists(file)) { return false; }
			var xmlForm1 = app.ReadFile(file,"UTF-8");
			var xml = $.parseXML(xmlForm1);
			var	rows = $(xml).children().find('row');
			var data = [];
			rows.each(function(ind,ele){
				data.push($(ele).find('id').text()+'='+$(ele).find('value').text());
			});
			var datastring = '?' + data.join('&');
    		$.ajax({
				url: url + datastring,
				type: 'GET',
				dataType: 'html',
				beforeSend: function(a){  },
				success: function(a){
					if (a == 'OK') {
						app.DeleteFile(file);
						$('#msg2').text('Ficha enviada para o servidor').css('color','green');
					} else {
						$('#res').append('Houve problemas de conexão. A ficha não foi enviada para o servidor. Tente mais tarde.');
					}
        		},
				error: function(a,b,c){
					$('#res').append('Houve problemas de conexão. A ficha não foi enviada para o servidor. Tente mais tarde.');
				},
				complete: function(a,b){ }
			});
		}
//----------------------------------------------------------------------------------------------------------------------

    });
</script>
<style>
	body {
	    background-color:white;
	}
	div {
	    float:left;
	    width:100%;
        margin-bottom:20px;
        font-size:xx-small;
	}
	.msg {
		color:red;
	}
	#res {
        font-size:large;
        font-weight:bold;
	    background-color:lightgrey;
	}
</style>
<body>
    <div>
        <button id="voltar" disabled="disabled">Voltar</button>
		<h3 class="msg" id="msg1">Aguardo a recepção de tabelas do servidor</h3>
		<h3 class="msg" id="msg2">Aguardo o envio da ficha ao servidor</h3>
    </div>
    <div id="res">
    </div>
</body>
</html>
