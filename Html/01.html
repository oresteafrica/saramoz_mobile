<!doctype html>
<html>
<head>
    <title>Entrada dados</title>
    <meta name="viewport" content="width=device-width">
	<meta charset='utf-8'>
    <script src='file:///android_asset/app.js'></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyCIeZTMfIeXUkueMevGm5dizgIcmCFkKRo"></script>
    <script src="../Misc/jquery-3.1.1.js"></script>
</head>
<script>
    $(document).ready(function() {
		var curdir = app.GetAppPath();
		var form_main_file = curdir + '/Html/form_main.xml';
		var page00 = curdir + '/saramoz.html';
		var page05 = curdir + '/Html/05.html';
		if (app.FileExists(form_main_file)) {
	        window.location.href = page05;
		} else {
			if ( confirm('Achar as coordenadas ?') ) {
				init();
			} else {
				window.location.href = page05;
			}
		}
//----------------------------------------------------------------------------------------------------------------------
        $('#voltar').click(function(){ end(page00); });
//----------------------------------------------------------------------------------------------------------------------
        $('#continuar').click(function(){ end(page05); });
//----------------------------------------------------------------------------------------------------------------------        
    });
//----------------------------------------------------------------------------------------------------------------------
    function init() {
        var ag = '<img alt="aguarde" src="../Img/small_rect__blue_load.gif" />';
        $('#lat').html(ag);
        $('#lon').html(ag);
        $('#pre').html(ag);
        $('#met').html(ag);
        loc = app.CreateLocator( "GPS,Network" );
        loc.SetOnChange( locback ); 
        loc.SetRate( 10 ); // seconds
        loc.Start();
    }
//----------------------------------------------------------------------------------------------------------------------
    function locback(data) {
        lat = data.latitude;
        lon = data.longitude;
        $('#lat').text(lat);
        $('#lon').text(lon);
        $('#pre').text(data.accuracy+' m.');
        $('#met').text(data.provider);
        $('#buttons > button').show();

        var curfile = window.location.href;
        var curdir = curfile.substring(7, curfile.lastIndexOf('/'));
		var latlon_file = curdir + '/latlon.xml';
		var latlon_xml = '<?xml version="1.0" encoding="UTF-8"?><coord><lat>'+lat+'</lat><lon>'+lon+'</lon></coord>';
		app.WriteFile(latlon_file,latlon_xml,"utf-8");

        $.ajax({
            url: 'http://sis-ma.in/sara/php/ping.php',
            success: function(result){
                var myLatLng = {lat: lat, lng: lon};
                var map = new google.maps.Map($('#map')[0], {
                    zoom: 4,
                    center: myLatLng,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    disableDefaultUI: true
                });
                var marker = new google.maps.Marker({
                    position: myLatLng,
                    map: map,
                    title: 'Estou aqui'
                });
            },
            error: function(result){
                $('#map').html('<p>Não se pode visualizar o mapa porque não há conexão Internet</p>');
            }
        });            
    }
//----------------------------------------------------------------------------------------------------------------------
    function end(url) {
        loc.Stop();
        window.location.href = url;
    }
//----------------------------------------------------------------------------------------------------------------------
</script>
<style>
	body {
	    background-color:white;
	}
	div {
	    float:left;
        margin-bottom:20px;
	    width:100%;
	}
    td {
        padding:4px;
	    background-color:white;
        color:black;
    }
    td:nth-child(odd) {
	    background-color:black;
        color:white;
    }
    #main {
	    width:100%;
    }
    #buttons {
        height:40px;
    }
    #buttons > button {
        display:none;
    }
    #coord {
        margin-left:6px;
    }
    #map {
        border:1px solid red;
        height:200px;
    }

</style>
<body>
    <div id="buttons">
        <button id="voltar">Voltar</button>
        <button id="continuar">Continuar</button>
    </div>
    <div id="main">
        <div id="coord">
            <table>
                <thead>
                </thead>
                <tbody>
                    <tr><td>Latitude</td><td id="lat"></td></tr>
                    <tr><td>Longitude</td><td id="lon"></td></tr>
                    <tr><td>Precisão</td><td id="pre"></td></tr>
                    <tr><td>Método</td><td id="met"></td></tr>
                </tbody>
            </table>
        </div>
        <div id="map"></div>
    </div>
</body>
</html>
