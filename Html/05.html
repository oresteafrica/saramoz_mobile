<!doctype html>
<html>
<head>
    <title>Form1</title>
    <meta name="viewport" content="width=device-width">
	<meta charset='utf-8'>
    <script src='file:///android_asset/app.js'></script>
    <script src="../Misc/jquery-3.1.1.js"></script>
</head>
<script>
    $(document).ready(function() {
		var auth = app.LoadNumber( 'auth', 0 );
		if ( auth != 1 ) {
			alert('O usuário não é cadastrado');
			window.location.href = "../saramoz.html";
		}
		var curdir = app.GetAppPath();
		var fileTabsXml = curdir + '/Html/tables.xml';
		var latlon_file = curdir + '/Html/latlon.xml';
		var form_main_file = curdir + '/Html/form_main.xml';

		if (app.FileExists(form_main_file)) {
			var xmlForm1 = app.ReadFile(form_main_file,"UTF-8");
			var xml = $.parseXML(xmlForm1);
			var	rows = $(xml).children().find('row');
			var field;
			var value;
			rows.each(function(ind,ele){
				field = $(ele).find('id').text();
				value = $(ele).find('value').text();
				switch (field) {
					case 'mz006': // select províncias
						$('#'+field).find('option[value= "'+value+'"]').attr('selected',true);
					case 'mz012': // select
						inject_sel(fileTabsXml, 'unit_type', 'mz012', value);
					case 'mz013': // select
						inject_sel(fileTabsXml, 'unit_authority', 'mz013', value);
					case 'mz014': // select
						inject_sel(fileTabsXml, 'ministries', 'mz014', value);
					case 'mz015': // select
						inject_sel(fileTabsXml, 'unit_state', 'mz015', value);
					case 'mz023': // select
						inject_sel(fileTabsXml, 'unit_service', 'mz023', value);
					case 'mz022': // select sim/não
						$('#'+field).find('option[value= "'+value+'"]').attr('selected',true);
					default: // text, number input
						$('#'+field).val(value);
				}
			});
		} else {
			inject_sel(fileTabsXml, 'unit_type', 'mz012');
			inject_sel(fileTabsXml, 'unit_authority', 'mz013');
			inject_sel(fileTabsXml, 'ministries', 'mz014');
			inject_sel(fileTabsXml, 'unit_state', 'mz015');
			inject_sel(fileTabsXml, 'unit_service', 'mz023');
			inject_latlon(latlon_file);
		}


//----------------------------------------------------------------------------------------------------------------------
        $('.voltar').click(function(){
            window.location.href = "../saramoz.html";
        });
//----------------------------------------------------------------------------------------------------------------------
        $('#gravar').click(function(){
			var curdir = app.GetAppPath();
			var form_main_file = curdir + '/Html/form_main.xml';
			var fileUser = curdir + '/Html/user.xml';
			var today = new Date();
			var dd = today.getDate();
			var mm = today.getMonth()+1; //January is 0!
			var yyyy = today.getFullYear();
			var mysql_today = yyyy + '-' + mm + '-' + dd;
			if (app.FileExists(fileUser)) {
				var xmlUser = app.ReadFile(fileUser,"UTF-8");
				var user = $.parseXML(xmlUser);
				var local_id = $(user).children().find('id').text();
			} else {
				alert('O usuário não é cadastrado. Deve efectuar login.');
				return;
			}
			var res = '<?xml version="1.0" encoding="UTF-8"?><form_main>';
			res += '<row><id>op_id</id><value>' + local_id + '</value></row>';
			res += '<row><id>in_date</id><value>' + mysql_today + '</value></row>';
			var second_trs = $('#form_elements > table > tbody > tr:odd');
			second_trs.each(function(){
				var ele = $(this).children().eq(0).children().eq(0);
				res += '<row><id>' + $(ele).prop('id') + '</id><value>' + $(ele).val() + '</value></row>';
		    });
			res += '</form_main>';
			app.WriteFile(form_main_file,res,"utf-8");
			alert('O formulário foi gravado na base de dados local. Actualize o servidor para enviar ao servidor remoto.');
    	    window.location.href = "../saramoz.html";
        });
//----------------------------------------------------------------------------------------------------------------------
		function inject_sel(file, tabname, idsel, opt = 1) {
			var xml_string = app.ReadFile(file);
			var xml = $.parseXML(xml_string);
			var tabs = $(xml).children();
			var options = '';
            tabs.each(function(){
				var rows = $(this).children();
	            rows.each(function(){
					if ( this.tagName == tabname ) {
						var row = $(this).children();
		            	row.each(function(){
							var id = $(this).find('id').text();
							var na = $(this).find('name').text();
							if (opt == id) {
								options += '<option value="' + id + '" selected="selected">' + na + '</option>';
							} else {
								options += '<option value="' + id + '">' + na + '</option>';
							}
		            	})
					}

	            })
            })
			$('#'+idsel).html(options);
		}
//----------------------------------------------------------------------------------------------------------------------
		function inject_latlon(latlon_file) {
			var xml_string = app.ReadFile(latlon_file);
			var xml = $.parseXML(xml_string);
			var coor = $(xml).children();
			var lat = $(coor).find('lat').text();
			var lon = $(coor).find('lon').text();
			// valores calculados para Moçambique
			var lat_min = -28;
			var lat_max = -9;
			var lon_min = 28;
			var lon_max = 53;
			if ( lat < lat_min || lat > lat_max || lon < lon_min || lon > lon_max) {
				alert('As coordenadas são fora do território moçambicano');
			} else {
				$('#mz026').val(lat);
				$('#mz027').val(lon);
			}
		}
//----------------------------------------------------------------------------------------------------------------------

    });
</script>
<style>
	body {
	    background-color:Ivory;
	}
	div {
	    float:left;
	    width:100%;
        margin-bottom:20px;
        font-size:x-small;
	}
	#form_elements {
		margin-bottom:500px;
	}
    table {
        border-collapse:collapse;
	    width:80%;
        margin-bottom:20px;
    }
    td {
        border:1px solid black;
        padding:2px;
    }
    input {
    }
    select {
        font-size:x-small;
    }
	button {
		margin-right:8px;
	}
</style>
<body>
    <div>
        <button class="voltar">Voltar sem gravar</button>
    </div>
    <div class="inform" id="form_elements">
        <table>
            <tbody>
                <tr>
                    <td>MZ001</td>
                    <td>Código da unidade</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="text" id="mz001"></td>
                </tr>
                <tr>
                    <td>MZ003</td>
                    <td>Nome da unidade</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="text" id="mz003"></td>
                </tr>
                <tr>
                    <td>MZ004</td>
                    <td>Nome curto da unidade</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="text" id="mz004"></td>
                </tr>
                <tr>
                    <td>MZ005</td>
                    <td>Localização da unidade</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="text" id="mz005"></td>
                </tr>
                <tr>
                    <td>MZ006</td>
                    <td>Província</td>
                </tr>
                <tr>
                    <td colspan="2">
						<select id="mz006">
							<option value="2">Niassa</option>
							<option value="3">Cabo Delgado</option>
							<option value="4">Nampula</option>
							<option value="5">Tete</option>
							<option value="6">Zambezia</option>
							<option value="7">Manica</option>
							<option value="8">Sofala</option>
							<option value="9">Gaza</option>
							<option value="10">Inhambane</option>
							<option value="11">Maputo cidade</option>
							<option value="12">Maputo</option>
						</select>
					</td>
                </tr>
                <tr>
                    <td>MZ007</td>
                    <td>Distrito</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="text" id="mz007"></td>
                </tr>
                <tr>
                    <td>MZ008</td>
                    <td>Posto Administrativo</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="text" id="mz008"></td>
                </tr>
                <tr>
                    <td>MZ009</td>
                    <td>Localidade</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="text" id="mz009"></td>
                </tr>
                <tr>
                    <td>MZ010</td>
                    <td>Endereço físico</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="text" id="mz010"></td>
                </tr>
                <tr>
                    <td>MZ011</td>
                    <td>Informação de contacto</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="text" id="mz011"></td>
                </tr>
                <tr>
                    <td>MZ012</td>
                    <td>Tipo de unidades</td>
                </tr>
                <tr>
                    <td colspan="2"><select id="mz012"></select></td>
                </tr>
                <tr>
                    <td>MZ013</td>
                    <td>Autoridade gestora</td>
                </tr>
                <tr>
                    <td colspan="2"><select id="mz013"></select></td>
                </tr>
                <tr>
                    <td>MZ014</td>
                    <td>Ministério de Tutela</td>
                </tr>
                <tr>
                    <td colspan="2"><select id="mz014"></select></td>
                </tr>
                <tr>
                    <td>MZ015</td>
                    <td>Estado operacional</td>
                </tr>
                <tr>
                    <td colspan="2"><select id="mz015"></select></td>
                </tr>
                <tr>
                    <td>MZ016</td>
                    <td>Data de construção</td></tr>
                <tr>
                    <td colspan="2"><input type="date" id="mz016"></td>
                </tr>
                <tr>
                    <td>MZ017</td>
                    <td>Data de início de funcionamento</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="date" id="mz017"></td>
                </tr>
                <tr>
                    <td>MZ018</td>
                    <td>Data da última requalificação</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="date" id="mz018"></td>
                </tr>
                <tr>
                    <td>MZ019</td>
                    <td>Data do último estado operacional</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="date" id="mz019"></td>
                </tr>
                <tr>
                    <td>MZ020</td>
                    <td>Data de alteração de dados da Unidade de Saúde</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="date" id="mz020"></td>
                </tr>
                <tr>
                    <td>MZ022</td>
                    <td>Consultas externas apenas (sem internamento)</td>
                </tr>
                <tr>
                    <td colspan="2">
						<select id="mz022">
							<option value="0" selected="selected">Não</option>
							<option value="1">Sim</option>
						</select>
					</td>
                </tr>
                <tr>
                    <td>MZ023</td>
                    <td>Tipos de serviços prestados</td>
                </tr>
                <tr>
                    <td colspan="2"><select id="mz023"></select></td>
                </tr>

                <tr>
                    <td>MZ025</td>
                    <td>Altitude (metros)</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="number" step="1" min="0" id="mz025"></td>
                </tr>
                <tr>
                    <td>MZ026</td>
                    <td>Latitude (sistema WGS84)</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="number" step="0.000001" min="-28" max="-9" id="mz026"></td>
                </tr>
                <tr>
                    <td>MZ027</td>
                    <td>Longitude (sistema WGS84)</td>
                </tr>
                <tr>
                    <td colspan="2"><input type="number" step="0.000001" min="28" max="53" id="mz027"></td>
                </tr>
            </tbody>
        </table>
        <button id="gravar">Gravar os dados</button>
        <button class="voltar">Voltar sem gravar</button>
    </div>
</body>
</html>
